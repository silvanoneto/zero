# Docker Compose Principal - Constituição 2.0
# Orquestra todos os serviços do ecossistema

services:
  # IPFS Node
  ipfs:
    image: ipfs/go-ipfs:latest
    container_name: constituicao-ipfs
    ports:
      - "4001:4001"    # P2P
      - "5001:5001"    # API
      - "8081:8080"    # Gateway (evitar conflito)
    volumes:
      - ipfs-data:/data/ipfs
    environment:
      - IPFS_PROFILE=server
    restart: unless-stopped
    networks:
      - constituicao-network

  # Helia Gateway Service (P2P Backend)
  helia-gateway:
    build: ./helia-gateway
    container_name: constituicao-helia-gateway
    ports:
      - "8080:8080"    # HTTP API
      - "4002:4002"    # P2P libp2p TCP
      - "4003:4003"    # P2P libp2p WebSocket
    environment:
      - HELIA_GATEWAY_URL=http://localhost:8080
      - PORT=8080
      - NODE_ENV=development
      - LOG_LEVEL=info
      - RATE_LIMIT_WINDOW_MS=900000
      - RATE_LIMIT_MAX_REQUESTS=1000
      - P2P_ENABLED=true
      - P2P_TCP_PORT=4002
      - P2P_WS_PORT=4003
      - DEBUG=libp2p:*,-libp2p:websockets:*,-libp2p:mplex:*
    depends_on:
      - ipfs
    volumes:
      - ./helia-gateway/logs:/app/logs
      - helia-p2p-data:/app/data
    restart: unless-stopped
    networks:
      - constituicao-network

  # Helia Gateway Peer 2 (Segundo nó P2P para testes)
  helia-gateway-peer2:
    build: ./helia-gateway
    container_name: constituicao-helia-gateway-peer2
    ports:
      - "8082:8080"    # HTTP API na porta 8082
      - "4004:4004"    # P2P libp2p TCP (porta interna também é 4004)
      - "4005:4005"    # P2P libp2p WebSocket (porta interna também é 4005)
    environment:
      - HELIA_GATEWAY_URL=http://localhost:8082
      - PORT=8080
      - NODE_ENV=development
      - LOG_LEVEL=info
      - RATE_LIMIT_WINDOW_MS=900000
      - RATE_LIMIT_MAX_REQUESTS=1000
      - P2P_ENABLED=true
      - P2P_TCP_PORT=4004
      - P2P_WS_PORT=4005
    depends_on:
      - ipfs
      - helia-gateway
    volumes:
      - ./helia-gateway/logs-peer2:/app/logs
      - helia-p2p-data-peer2:/app/data
    restart: unless-stopped
    networks:
      - constituicao-network

  # PostgreSQL for Graph Node
  postgres:
    image: postgres:14
    container_name: constituicao-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: graph-node
      POSTGRES_PASSWORD: let-me-in
      POSTGRES_DB: graph-node
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - constituicao-network

  # The Graph Node
  graph-node:
    image: graphprotocol/graph-node:latest
    platform: linux/amd64
    container_name: constituicao-graph-node
    ports:
      - "8000:8000"    # HTTP
      - "8001:8001"    # WebSocket
      - "8020:8020"    # JSON-RPC admin
      - "8030:8030"    # Indexing status
      - "8040:8040"    # Metrics
    environment:
      postgres_host: postgres
      postgres_user: graph-node
      postgres_pass: let-me-in
      postgres_db: graph-node
      ipfs: 'ipfs:5001'
      ethereum: 'localhost:http://host.docker.internal:8545'
      GRAPH_LOG: info
    depends_on:
      - postgres
      - ipfs
    restart: unless-stopped
    networks:
      - constituicao-network
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Frontend (Next.js)
  frontend:
    build: ./frontend
    container_name: constituicao-frontend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_CHAIN_ID=31337
      - NEXT_PUBLIC_RPC_URL=http://localhost:8545
      - NEXT_PUBLIC_SUBGRAPH_URL=http://localhost:8000/subgraphs/name/constituicao-2-0
      - NEXT_PUBLIC_HELIA_GATEWAY=http://localhost:8080
      - NEXT_PUBLIC_P2P_GATEWAY=http://localhost:8080
    depends_on:
      - graph-node
      - helia-gateway
    restart: unless-stopped
    networks:
      - constituicao-network

volumes:
  ipfs-data:
    driver: local
  postgres-data:
    driver: local
  helia-p2p-data:
    driver: local
  helia-p2p-data-peer2:
    driver: local

networks:
  constituicao-network:
    driver: bridge

# Usage:
# docker-compose up -d          # Start all services
# docker-compose logs -f        # Follow logs
# docker-compose down           # Stop all services
# docker-compose down -v        # Stop and remove volumes (reset)
