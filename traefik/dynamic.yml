# Traefik Dynamic Configuration
# https://doc.traefik.io/traefik/routing/overview/

http:
  # Routers
  routers:
    # Dashboard Router
    dashboard:
      rule: "Host(`traefik.revolucao-cibernetica.local`)"
      service: api@internal
      entryPoints:
        - websecure
      middlewares:
        - auth
        - security-headers
        - rate-limit
      tls:
        # certResolver: letsencrypt  # Usando certificados mkcert locais

    # Frontend Router
    frontend:
      rule: "Host(`revolucao-cibernetica.local`) || Host(`www.revolucao-cibernetica.local`)"
      service: frontend
      entryPoints:
        - websecure
      middlewares:
        - security-headers
        - compression
        - rate-limit
      tls:
        # certResolver: letsencrypt  # Usando certificados mkcert locais

    # Prometheus Router
    prometheus:
      rule: "Host(`prometheus.revolucao-cibernetica.local`)"
      service: prometheus
      entryPoints:
        - websecure
      middlewares:
        - auth
        - security-headers
      tls:
        # certResolver: letsencrypt  # Usando certificados mkcert locais

    # Grafana Router
    grafana:
      rule: "Host(`grafana.revolucao-cibernetica.local`)"
      service: grafana
      entryPoints:
        - websecure
      middlewares:
        - security-headers
      tls:
        # certResolver: letsencrypt  # Usando certificados mkcert locais

    # IPFS Gateway Router
    ipfs-gateway:
      rule: "Host(`ipfs.revolucao-cibernetica.local`)"
      service: ipfs-gateway
      entryPoints:
        - websecure
      middlewares:
        - security-headers
        - rate-limit
      tls:
        # certResolver: letsencrypt  # Usando certificados mkcert locais

  # Services
  services:
    frontend:
      loadBalancer:
        servers:
          - url: "http://revolucao-cibernetica-app:3000"
        healthCheck:
          path: /api/health
          interval: "10s"
          timeout: "3s"

    prometheus:
      loadBalancer:
        servers:
          - url: "http://prometheus:9090"

    grafana:
      loadBalancer:
        servers:
          - url: "http://grafana:3000"

    ipfs-gateway:
      loadBalancer:
        servers:
          - url: "http://helia-gateway:8080"

  # Middlewares
  middlewares:
    # Basic Auth for Dashboard/Prometheus
    auth:
      basicAuth:
        users:
          # admin:revolucao (use htpasswd to generate)
          - "admin:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/"
        realm: "Revolucao Cibernetica - Admin Area"

    # Security Headers
    security-headers:
      headers:
        # HTTPS
        sslRedirect: true
        sslProxyHeaders:
          X-Forwarded-Proto: https
        
        # Security Headers
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsSeconds: 63072000  # 2 years
        stsPreload: true
        
        # Custom Security Headers
        customFrameOptionsValue: "SAMEORIGIN"
        customResponseHeaders:
          X-Frame-Options: "SAMEORIGIN"
          X-XSS-Protection: "1; mode=block"
          X-Content-Type-Options: "nosniff"
          Referrer-Policy: "strict-origin-when-cross-origin"
          Permissions-Policy: "camera=(), microphone=(), geolocation=()"
          
        # Content Security Policy (adjust as needed)
        contentSecurityPolicy: |
          default-src 'self';
          script-src 'self' 'unsafe-inline' 'unsafe-eval';
          style-src 'self' 'unsafe-inline';
          img-src 'self' data: https:;
          font-src 'self' data:;
          connect-src 'self' https:;
          frame-ancestors 'self';

    # Compression
    compression:
      compress: {}

    # Rate Limiting
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1s

    # CORS (if needed)
    cors:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowOriginList:
          - "*"
        accessControlMaxAge: 100
        addVaryHeader: true

    # Circuit Breaker
    circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.5 || ResponseCodeRatio(500, 600, 0, 600) > 0.3"

    # Retry
    retry:
      retry:
        attempts: 3
        initialInterval: "100ms"

# TCP Routers (if needed)
# tcp:
#   routers: {}
#   services: {}

# UDP Routers (if needed)
# udp:
#   routers: {}
#   services: {}

# TLS Certificates
tls:
  certificates:
    - certFile: /certs/revolucao-cibernetica.local+4.pem
      keyFile: /certs/revolucao-cibernetica.local+4-key.pem
  
  options:
    default:
      minVersion: VersionTLS12
      cipherSuites:
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
      curvePreferences:
        - CurveP521
        - CurveP384
      sniStrict: false  # Permitir SNI flex√≠vel para desenvolvimento

    modern:
      minVersion: VersionTLS13
